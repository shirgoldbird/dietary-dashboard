---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import dietaryData from '../../data/dietary-restrictions.json';

export function getStaticPaths() {
  return dietaryData.members.map((member) => ({
    params: { person: member.name.toLowerCase().replace(/\s+/g, '-') },
    props: { member },
  }));
}

const { member } = Astro.props;

// Filter out "Attending?" and "Approved?" from restrictions
const restrictions = member.restrictions.filter(r =>
  !r.item.toLowerCase().includes('attending') &&
  !r.item.toLowerCase().includes('approved')
);

const airborneRestrictions = restrictions.filter(r => r.severity === "airborne");
const otherRestrictions = restrictions.filter(r => r.severity !== "airborne");
const hasOnlyNone = restrictions.length === 1 && restrictions[0].item.toLowerCase() === 'none';
const hasNoRestrictions = restrictions.length === 0;
---

<Layout title={`Preview - ${member.name} - Dietary Dashboard`}>
  <div class="w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <Header />

    <main class="space-y-6">
      {/* Personalized Header */}
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border-l-4 border-blue-500">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3">
          Hi {member.name}! ðŸ‘‹
        </h2>
        <p class="text-gray-700 dark:text-gray-300 mb-4">
          This is how your dietary restrictions will appear when someone includes you in a meal plan.
          Please review and confirm this information is accurate.
        </p>
        {member.approved ? (
          <div class="inline-flex items-center gap-2 px-3 py-2 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-lg">
            <i class="fa-solid fa-check-circle"></i>
            <span class="font-medium">Your information has been approved</span>
          </div>
        ) : (
          <div class="inline-flex items-center gap-2 px-3 py-2 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 rounded-lg">
            <i class="fa-solid fa-clock"></i>
            <span class="font-medium">Pending approval - Please review and confirm this is correct</span>
          </div>
        )}
      </div>

      {/* Member's Restrictions */}
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border-l-4 border-blue-500">
        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          Your Dietary Restrictions
        </h3>

        {/* Airborne Allergies */}
        {airborneRestrictions.length > 0 && (
          <div class="mb-6 bg-red-50 dark:bg-red-950 border-2 border-red-500 dark:border-red-600 rounded-lg p-4">
            <h4 class="text-lg font-bold text-red-700 dark:text-red-400 mb-3 flex items-center gap-2">
              <i class="fa-solid fa-triangle-exclamation"></i>
              AIRBORNE ALLERGIES
            </h4>
            <ul class="space-y-2">
              {airborneRestrictions.map(r => (
                <li key={r.item} class="text-red-900 dark:text-red-200 font-medium">
                  â€¢ {r.item}
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Other Restrictions */}
        {hasOnlyNone || hasNoRestrictions ? (
          <p class="text-gray-700 dark:text-gray-300 text-lg">
            <span class="font-semibold">No dietary restrictions</span>
          </p>
        ) : otherRestrictions.length > 0 ? (
          <div>
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-400 mb-3">
              Other Restrictions
            </h4>
            <ul class="space-y-2">
              {otherRestrictions.map(r => (
                <li key={r.item} class="text-gray-700 dark:text-gray-300">
                  <span class="font-medium">â€¢ {r.item}</span>
                  {r.severity !== 'yes' && <span class="text-sm text-gray-500 dark:text-gray-400"> ({r.severity})</span>}
                </li>
              ))}
            </ul>
          </div>
        ) : null}

        {/* Action Note */}
        {!member.approved && (
          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <p class="text-sm text-gray-600 dark:text-gray-400">
              If this information is incorrect or needs updating, please contact the organizer to make changes.
            </p>
          </div>
        )}
      </div>
    </main>

    <Footer />
  </div>
</Layout>
